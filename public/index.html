<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio Phone Dialer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .dialer {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .dialer h1 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        input[type="tel"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            width: 200px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            font-weight: bold;
        }
        .status.success { color: green; }
        .status.error { color: red; }
        .status.info { color: blue; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .status-initiated { color: orange; }
        .status-completed { color: green; }
        .status-failed { color: red; }
        .status-busy { color: purple; }
        .status-no-answer { color: gray; }
        
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="dialer">
        <h1>Twilio Phone Dialer</h1>
        <div class="form-group">
            <input type="tel" 
                   id="phoneNumber" 
                   placeholder="+1234567890" 
                   pattern="^\+?[1-9]\d{1,14}$"
                   title="Enter phone number with country code (e.g., +1234567890)">
            <button id="callButton" onclick="makeCall()">Dial</button>
        </div>
        <div id="status" class="status"></div>
    </div>

    <h2>Call History</h2>
    <table id="callsTable">
        <thead>
            <tr>
                <th>Time</th>
                <th>Phone Number</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Recording</th>
                <th>Transcript</th>
            </tr>
        </thead>
        <tbody id="callsBody">
            <tr class="empty-state">
                <td colspan="6">No calls yet. Make your first call above!</td>
            </tr>
        </tbody>
    </table>

    <script>
        let isLoading = false;

        async function makeCall() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const button = document.getElementById('callButton');
            const statusDiv = document.getElementById('status');
            
            if (!phoneNumber) {
                showStatus('Please enter a phone number', 'error');
                return;
            }

            if (!phoneNumber.match(/^\+?[1-9]\d{1,14}$/)) {
                showStatus('Please enter a valid phone number (e.g., +1234567890)', 'error');
                return;
            }

            button.disabled = true;
            isLoading = true;
            showStatus('Initiating call...', 'info');
            
            try {
                const response = await fetch('/api/call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Call failed');
                }
                
                showStatus(`Call initiated successfully! Call SID: ${result.callSid}`, 'success');
                document.getElementById('phoneNumber').value = '';
                
                setTimeout(refreshCalls, 1000);
                
            } catch (error) {
                console.error('Error making call:', error);
                showStatus(`Failed to initiate call: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                isLoading = false;
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = 'status';
                }, 5000);
            }
        }

        async function refreshCalls() {
            try {
                const response = await fetch('/api/calls');
                const calls = await response.json();
                
                const tbody = document.getElementById('callsBody');
                
                if (calls.length === 0) {
                    tbody.innerHTML = '<tr class="empty-state"><td colspan="6">No calls yet. Make your first call above!</td></tr>';
                    return;
                }
                
                tbody.innerHTML = calls.map(call => {
                    const createdAt = new Date(call.created_at).toLocaleString();
                    const duration = call.duration_seconds ? `${call.duration_seconds}s` : '-';
                    const recordingLink = call.recording_url ? `<a href="${call.recording_url}" target="_blank">Listen</a>` : '-';
                    const transcript = call.transcript_text ? 
                        `<a href="#" onclick="showTranscript('${call.transcript_text.replace(/'/g, '\\\'')}')" title="Click to view">View</a>` : 
                        call.transcript_status || '-';
                    
                    return `
                        <tr>
                            <td>${createdAt}</td>
                            <td>${call.phone_number}</td>
                            <td>${duration}</td>
                            <td class="status-${call.call_status}">${call.call_status}</td>
                            <td>${recordingLink}</td>
                            <td>${transcript}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error fetching calls:', error);
                showStatus('Failed to refresh call history', 'error');
            }
        }

        function showTranscript(text) {
            alert(`Transcript:\n\n${text}`);
        }

        document.getElementById('phoneNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !isLoading) {
                makeCall();
            }
        });

        refreshCalls();
        setInterval(refreshCalls, 5000);
    </script>
</body>
</html>